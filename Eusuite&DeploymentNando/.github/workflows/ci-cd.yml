                # =============================================================================
# EUSuite Platform - CI/CD Pipeline (Self-Hosted Runner)
# =============================================================================
name: EUSuite Platform CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: dylan016504

jobs:
  # ===========================================================================
  # BUILD & DEPLOY ALL SERVICES
  # ===========================================================================
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show runner info
        run: |
          echo "ðŸƒ Running on self-hosted runner"
          echo "ðŸ“‚ Working directory: $(pwd)"
          docker --version
          kubectl version --client || echo "kubectl not found"

      # ========================================
      # LOGIN TO DOCKER HUB
      # ========================================
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ========================================
      # BUILD PUBLIC BACKEND
      # ========================================
      - name: Build Public Backend
        run: |
          echo "ðŸ”¨ Building eusuite-public-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-public-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:${{ github.sha }}

      # ========================================
      # BUILD PUBLIC FRONTEND
      # ========================================
      - name: Build Public Frontend
        run: |
          echo "ðŸ”¨ Building eusuite-public-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-public-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:${{ github.sha }}

      # ========================================
      # BUILD COMPANY BACKEND
      # ========================================
      - name: Build Company Backend
        run: |
          echo "ðŸ”¨ Building eusuite-company-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-company-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:${{ github.sha }}

      # ========================================
      # BUILD COMPANY FRONTEND
      # ========================================
      - name: Build Company Frontend
        run: |
          echo "ðŸ”¨ Building eusuite-company-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-company-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:${{ github.sha }}

      # ========================================
      # BUILD SUPERADMIN BACKEND
      # ========================================
      - name: Build Superadmin Backend
        run: |
          echo "ðŸ”¨ Building eusuite-superadmin-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-superadmin-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:${{ github.sha }}

      # ========================================
      # BUILD SUPERADMIN FRONTEND
      # ========================================
      - name: Build Superadmin Frontend
        run: |
          echo "ðŸ”¨ Building eusuite-superadmin-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:${{ github.sha }}

      # ========================================
      # DEPLOY TO KUBERNETES VIA SSH
      # ========================================
      - name: Deploy to Kubernetes via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸš€ Deploying to Kubernetes on $SSH_HOST..."
          
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null
          
          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'ENDSSH'
            echo "ðŸ“¥ Downloading latest platform.yaml..."
            curl -sL -o /tmp/platform.yaml https://raw.githubusercontent.com/Dylan0165/EUsuite-Platform/main/Eusuite%26DeploymentNando/k8s/platform.yaml
            
            echo "ðŸ“¦ Applying Kubernetes manifests..."
            kubectl apply -f /tmp/platform.yaml
            
            echo "ðŸ”„ Restarting deployments to pull new images..."
            kubectl rollout restart deployment/eusuite-public-backend -n eucloud || true
            kubectl rollout restart deployment/eusuite-public-frontend -n eucloud || true
            kubectl rollout restart deployment/eusuite-company-backend -n eucloud || true
            kubectl rollout restart deployment/eusuite-company-frontend -n eucloud || true
            kubectl rollout restart deployment/eusuite-superadmin-backend -n eucloud || true
            kubectl rollout restart deployment/eusuite-superadmin-frontend -n eucloud || true
            
            echo "â³ Waiting for rollout..."
            kubectl rollout status deployment/eusuite-public-frontend -n eucloud --timeout=120s || true
            kubectl rollout status deployment/eusuite-company-frontend -n eucloud --timeout=120s || true
            kubectl rollout status deployment/eusuite-superadmin-frontend -n eucloud --timeout=120s || true
            
            echo "âœ… Deployment complete!"
            kubectl get pods -n eucloud | grep eusuite-
          ENDSSH

      # ========================================
      # VERIFY DEPLOYMENT
      # ========================================
      - name: Verify Deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "âœ… Verifying deployment..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "kubectl get pods -n eucloud && kubectl get svc -n eucloud | grep eusuite-"

      - name: Deployment Complete
        run: |
          echo "ðŸŽ‰ EUSuite Platform deployed successfully!"
          echo "ðŸ“¦ Images pushed to Docker Hub: ${{ env.IMAGE_PREFIX }}/eusuite-*"
