# =============================================================================
# EUSuite Platform - CI/CD Pipeline (Self-Hosted Runner)
# =============================================================================
name: EUSuite Platform CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: dylan016504

jobs:
  # ===========================================================================
  # BUILD & DEPLOY ALL SERVICES
  # ===========================================================================
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show runner info
        run: |
          echo "üèÉ Running on self-hosted runner"
          echo "üìÇ Working directory: $(pwd)"
          docker --version
          kubectl version --client || echo "kubectl not found"

      # ========================================
      # LOGIN TO DOCKER HUB
      # ========================================
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ========================================
      # BUILD EUCLOUD CORE BACKEND (CRITICAL)
      # ========================================
      - name: Build EUCloud Core Backend
        run: |
          echo "üî® Building eucloud-backend (CORE)..."
          cd "Eusuite&DeploymentNando/apps/eucloud-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eucloud-backend:latest -t ${{ env.IMAGE_PREFIX }}/eucloud-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eucloud-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eucloud-backend:${{ github.sha }}

      # ========================================
      # BUILD PUBLIC BACKEND
      # ========================================
      - name: Build Public Backend
        run: |
          echo "üî® Building eusuite-public-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-public-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-backend:${{ github.sha }}

      # ========================================
      # BUILD PUBLIC FRONTEND
      # ========================================
      - name: Build Public Frontend
        run: |
          echo "üî® Building eusuite-public-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-public-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-public-frontend:${{ github.sha }}

      # ========================================
      # BUILD COMPANY BACKEND
      # ========================================
      - name: Build Company Backend
        run: |
          echo "üî® Building eusuite-company-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-company-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-backend:${{ github.sha }}

      # ========================================
      # BUILD COMPANY FRONTEND
      # ========================================
      - name: Build Company Frontend
        run: |
          echo "üî® Building eusuite-company-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-company-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-company-frontend:${{ github.sha }}

      # ========================================
      # BUILD SUPERADMIN BACKEND
      # ========================================
      - name: Build Superadmin Backend
        run: |
          echo "üî® Building eusuite-superadmin-backend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-superadmin-backend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-backend:${{ github.sha }}

      # ========================================
      # BUILD SUPERADMIN FRONTEND
      # ========================================
      - name: Build Superadmin Frontend
        run: |
          echo "üî® Building eusuite-superadmin-frontend..."
          cd "Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend"
          docker build -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:latest -t ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:${{ github.sha }} .
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:latest
          docker push ${{ env.IMAGE_PREFIX }}/eusuite-superadmin-frontend:${{ github.sha }}

      # ========================================
      # DEPLOY TO KUBERNETES (Direct - Runner is on server)
      # ========================================
      - name: Create Docker Hub Pull Secret
        run: |
          echo "üîê Creating Docker Hub secret for image pulling..."
          kubectl create namespace eucloud --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete secret dockerhub-credentials -n eucloud --ignore-not-found
          kubectl create secret docker-registry dockerhub-credentials \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username="${{ secrets.DOCKER_USERNAME }}" \
            --docker-password="${{ secrets.DOCKER_PASSWORD }}" \
            -n eucloud

      - name: Delete Old Deployments
        run: |
          echo "üóëÔ∏è Deleting old deployments to force fresh pull..."
          kubectl delete deployment --all -n eucloud --ignore-not-found || true
          kubectl delete service eusuite-public-backend eusuite-public-frontend eusuite-company-backend eusuite-company-frontend eusuite-superadmin-backend eusuite-superadmin-frontend eucloud-backend -n eucloud --ignore-not-found || true

      - name: Deploy to Kubernetes
        run: |
          echo "üöÄ Deploying to Kubernetes..."
          kubectl apply -f "Eusuite&DeploymentNando/k8s/platform.yaml"

      - name: Wait for Deployments
        run: |
          echo "‚è≥ Waiting for deployments to be ready..."
          kubectl rollout status deployment/eucloud-backend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-public-backend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-public-frontend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-company-backend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-company-frontend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-superadmin-backend -n eucloud --timeout=180s || true
          kubectl rollout status deployment/eusuite-superadmin-frontend -n eucloud --timeout=180s || true

      # ========================================
      # VERIFY DEPLOYMENT
      # ========================================
      - name: Verify Deployment
        run: |
          echo "‚úÖ Verifying deployment..."
          echo ""
          echo "üì¶ Pods:"
          kubectl get pods -n eucloud
          echo ""
          echo "üåê Services:"
          kubectl get svc -n eucloud

      - name: Deployment Complete
        run: |
          echo "üéâ EUSuite Platform deployed successfully!"
          echo "üì¶ Images pushed to Docker Hub: ${{ env.IMAGE_PREFIX }}/eusuite-*"
          echo ""
          echo "üåê Access URLs:"
          echo "  - Public Frontend:     http://192.168.124.50:30701"
          echo "  - Company Frontend:    http://192.168.124.50:30703"
          echo "  - Superadmin Frontend: http://192.168.124.50:30705"
          echo "  - EUCloud Core API:    http://192.168.124.50:30706"
