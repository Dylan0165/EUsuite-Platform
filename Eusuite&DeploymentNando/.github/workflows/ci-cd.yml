# =============================================================================
# EUSuite Platform - CI/CD Pipeline
# =============================================================================
# GitHub Actions workflow voor automatische build, test en deployment
# =============================================================================

name: EUSuite Platform CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dylan0165/eusuite

jobs:
  # ===========================================================================
  # DETECT CHANGES
  # ===========================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      public-backend: ${{ steps.filter.outputs.public-backend }}
      public-frontend: ${{ steps.filter.outputs.public-frontend }}
      company-backend: ${{ steps.filter.outputs.company-backend }}
      company-frontend: ${{ steps.filter.outputs.company-frontend }}
      superadmin-backend: ${{ steps.filter.outputs.superadmin-backend }}
      superadmin-frontend: ${{ steps.filter.outputs.superadmin-frontend }}
      k8s: ${{ steps.filter.outputs.k8s }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            public-backend:
              - 'Eusuite&DeploymentNando/apps/eusuite-public-backend/**'
            public-frontend:
              - 'Eusuite&DeploymentNando/apps/eusuite-public-frontend/**'
            company-backend:
              - 'Eusuite&DeploymentNando/apps/eusuite-company-backend/**'
            company-frontend:
              - 'Eusuite&DeploymentNando/apps/eusuite-company-frontend/**'
            superadmin-backend:
              - 'Eusuite&DeploymentNando/apps/eusuite-superadmin-backend/**'
            superadmin-frontend:
              - 'Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend/**'
            k8s:
              - 'Eusuite&DeploymentNando/k8s/**'

  # ===========================================================================
  # BUILD & TEST - PUBLIC BACKEND
  # ===========================================================================
  build-public-backend:
    needs: changes
    if: ${{ needs.changes.outputs.public-backend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-public-backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run tests
        working-directory: Eusuite&DeploymentNando/apps/eusuite-public-backend
        run: |
          pytest -v --tb=short || echo "No tests yet"
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-public-backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-public-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-public-backend:latest

  # ===========================================================================
  # BUILD - PUBLIC FRONTEND
  # ===========================================================================
  build-public-frontend:
    needs: changes
    if: ${{ needs.changes.outputs.public-frontend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Eusuite&DeploymentNando/apps/eusuite-public-frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-public-frontend
        run: npm ci
      
      - name: Build
        working-directory: Eusuite&DeploymentNando/apps/eusuite-public-frontend
        run: npm run build
        env:
          VITE_API_URL: https://eusuite.eu/api
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-public-frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-public-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-public-frontend:latest

  # ===========================================================================
  # BUILD & TEST - COMPANY BACKEND
  # ===========================================================================
  build-company-backend:
    needs: changes
    if: ${{ needs.changes.outputs.company-backend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-company-backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run tests
        working-directory: Eusuite&DeploymentNando/apps/eusuite-company-backend
        run: |
          pytest -v --tb=short || echo "No tests yet"
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-company-backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-company-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-company-backend:latest

  # ===========================================================================
  # BUILD - COMPANY FRONTEND
  # ===========================================================================
  build-company-frontend:
    needs: changes
    if: ${{ needs.changes.outputs.company-frontend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Eusuite&DeploymentNando/apps/eusuite-company-frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-company-frontend
        run: npm ci
      
      - name: Build
        working-directory: Eusuite&DeploymentNando/apps/eusuite-company-frontend
        run: npm run build
        env:
          VITE_API_URL: https://company.eusuite.eu/api
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-company-frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-company-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-company-frontend:latest

  # ===========================================================================
  # BUILD & TEST - SUPERADMIN BACKEND
  # ===========================================================================
  build-superadmin-backend:
    needs: changes
    if: ${{ needs.changes.outputs.superadmin-backend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-superadmin-backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run tests
        working-directory: Eusuite&DeploymentNando/apps/eusuite-superadmin-backend
        run: |
          pytest -v --tb=short || echo "No tests yet"
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-superadmin-backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-superadmin-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-superadmin-backend:latest

  # ===========================================================================
  # BUILD - SUPERADMIN FRONTEND
  # ===========================================================================
  build-superadmin-frontend:
    needs: changes
    if: ${{ needs.changes.outputs.superadmin-frontend == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend
        run: npm ci
      
      - name: Build
        working-directory: Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend
        run: npm run build
        env:
          VITE_API_URL: https://admin.eusuite.eu/api
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: Eusuite&DeploymentNando/apps/eusuite-superadmin-frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-superadmin-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-superadmin-frontend:latest

  # ===========================================================================
  # DEPLOY TO STAGING
  # ===========================================================================
  deploy-staging:
    needs: 
      - build-public-backend
      - build-public-frontend
      - build-company-backend
      - build-company-frontend
      - build-superadmin-backend
      - build-superadmin-frontend
    if: |
      always() && 
      github.ref == 'refs/heads/develop' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Deploy to staging
        run: |
          # Update image tags
          sed -i "s/:latest/:${{ github.sha }}/g" Eusuite&DeploymentNando/k8s/platform.yaml
          
          # Apply K8s manifests
          kubectl apply -f Eusuite&DeploymentNando/k8s/platform.yaml
          
          # Wait for rollout
          kubectl -n eusuite-platform rollout status deployment/eusuite-company-backend --timeout=300s
          kubectl -n eusuite-platform rollout status deployment/eusuite-superadmin-backend --timeout=300s
          kubectl -n eusuite-public rollout status deployment/eusuite-public-backend --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl -n eusuite-platform get pods
          kubectl -n eusuite-public get pods

  # ===========================================================================
  # DEPLOY TO PRODUCTION
  # ===========================================================================
  deploy-production:
    needs: 
      - build-public-backend
      - build-public-frontend
      - build-company-backend
      - build-company-frontend
      - build-superadmin-backend
      - build-superadmin-frontend
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Deploy to production
        run: |
          # Update image tags
          sed -i "s/:latest/:${{ github.sha }}/g" Eusuite&DeploymentNando/k8s/platform.yaml
          
          # Apply K8s manifests
          kubectl apply -f Eusuite&DeploymentNando/k8s/platform.yaml
          
          # Wait for rollout
          kubectl -n eusuite-platform rollout status deployment/eusuite-company-backend --timeout=300s
          kubectl -n eusuite-platform rollout status deployment/eusuite-superadmin-backend --timeout=300s
          kubectl -n eusuite-public rollout status deployment/eusuite-public-backend --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl -n eusuite-platform get pods
          kubectl -n eusuite-public get pods
      
      - name: Notify success
        if: success()
        run: |
          echo "ðŸš€ Production deployment successful!"
          # Add Slack/Discord notification here

  # ===========================================================================
  # CLEANUP OLD IMAGES
  # ===========================================================================
  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: Delete old container images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'eusuite-*'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'
